<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>play</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

</head>

<body>
    <!-- 방송하는 화면과 리모트 받는 화면 2개 만들기 -->
    <video id="localVideo" autoplay></video>

    <!-- 방송 시작 및 종료 버튼 생성 -->
    <div>
        <button id="call">Call</button>
        <button id="hangUp">Hang Up</button>
    </div>


    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const caller = new RTCPeerConnection();
            const callee = new RTCPeerConnection();

            const callBtn = document.getElementById('call');
            const hangUpBtn = document.getElementById('hangUp');

            const localVideo = document.getElementById('localVideo');

            callBtn.addEventListener('click', handlerClickCall);



            function handlerCallerOnicecandidate(e) {
                if (e.candidate) caller.addIceCandidate(e.candidate);
            }

            function handlerClickCall() {
                navigator.getUserMedia({
                    video: true,
                    audio: false
                }, getUserMediaSuccess, getUserMediaError);
            }

            function getUserMediaSuccess(mediaStream) {
                localVideo.srcObject = mediaStream;
                caller.addStream(mediaStream);
                caller.createOffer()
                    .then(sdp => createOfferSuccess(sdp))
                    .catch(e => createOfferError(e));
            }

            function createOfferSuccess(sdp) {
                console.log(sdp)
                caller.setLocalDescription(sdp);
                sendOffer(sdp);
            }

            function sendOffer(sdp) {
                socket.emit('start', sdp);
            }

            socket.on('new_remote', (sdp) => {
                caller.setRemoteDescription(sdp);
                caller.onicecandidate = handlerCallerOnicecandidate;
            })

            function createAnswerError(e) {
                console.log(e);
            }

            function createOfferError(e) {
                console.log(e);
            }

            function getUserMediaError(e) {
                console.log(e);
            }
        });
    </script>
</body>

</html>