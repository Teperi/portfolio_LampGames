<html>

<head>
    <meta charset="UTF-8" />
    <title>Multiplayer Experiment</title>
    <!-- Load the Phaser game library -->
    <script src="//cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser.js"></script>

</head>

<body>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        let config = {
            // 오토로 캔버스 만들어줌
            type: Phaser.AUTO,
            // 위 아래 크기 조정
            width: 800,
            height: 600,

            physics: {
                default: 'arcade',
                arcade: {
                    gravity: {
                        y: 0
                    }
                }
            },
            // 사용하는 신 지정
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        let game = new Phaser.Game(config);

        let player;
        //이동 관련
        let cursors;
        // 공격 관련
        let bullet;

        var socket = io(); // This triggers the 'connection' event on the server

        function preload() {
            this.load.image('tile', 'assets/tile.png');
            this.load.image('bullet', 'assets/bullet.png');
            this.load.image('tank', 'assets/tank.png');
        }

        function create() {
            this.add.tileSprite(0, 0, config.width, config.height, 'tile').setOrigin(0, 0);
            // 플레이어 생성(맵 가운데)
            player = this.physics.add.sprite(Math.random() * config.width, Math.random() * config.height, 'tank');
            player.displayWidth = 42;
            player.displayHeight = 46;
            player.setCollideWorldBounds(true);

            // 화살표와 wasd 모두 사용할 수 있도록 설정
            cursors = this.input.keyboard.addKeys({
                'up1': Phaser.Input.Keyboard.KeyCodes.UP,
                'up2': Phaser.Input.Keyboard.KeyCodes.W,
                'down1': Phaser.Input.Keyboard.KeyCodes.DOWN,
                'down2': Phaser.Input.Keyboard.KeyCodes.S,
                'left1': Phaser.Input.Keyboard.KeyCodes.LEFT,
                'left2': Phaser.Input.Keyboard.KeyCodes.A,
                'right1': Phaser.Input.Keyboard.KeyCodes.RIGHT,
                'right2': Phaser.Input.Keyboard.KeyCodes.D,
                'space': Phaser.Input.Keyboard.KeyCodes.SPACE,
                'shift': Phaser.Input.Keyboard.KeyCodes.SHIFT
            });

            bullets = this.physics.add.group();

            // 맵 모든 영역을 클릭하면 반응하도록 해주는 함수
            this.input.on('pointerdown', function() {

                // 방향 및 속도 계산 함수
                var start_x = Math.cos(player.rotation + Math.PI / 2) * 30;
                var start_y = Math.sin(player.rotation + Math.PI / 2) * 30;


                // 방향 및 속도 계산 함수
                var speed_x = Math.cos(player.rotation + Math.PI / 2) * 300;
                var speed_y = Math.sin(player.rotation + Math.PI / 2) * 300;
                // bullet 만들어서 발사함
                let bullet = bullets.create(player.x + start_x, player.y + start_y, 'bullet');
                bullet.setCollideWorldBounds(false);
                bullet.setVelocity(speed_x, speed_y);
            });

            socket.emit('new-player', {
                x: player.x,
                y: player.y,
                angle: player.rotation
            });

        }


        function update() {
            // 좌우 컨트롤
            if (cursors.left1.isDown || cursors.left2.isDown) {
                player.setVelocityX(-150);
            } else if (cursors.right1.isDown || cursors.right2.isDown) {
                player.setVelocityX(150);
            } else {
                player.setVelocityX(0);
            }

            // 상하 컨트롤
            if (cursors.up1.isDown || cursors.up2.isDown) {
                player.setVelocityY(-150);
            } else if (cursors.down1.isDown || cursors.down2.isDown) {
                player.setVelocityY(150);
            } else {
                player.setVelocityY(0);
            }

            // 유저의 뱃머리를 마우스 커서 위치로 항상 돌아가도록 설정
            player.rotation = (Phaser.Math.Angle.Between(player.x, player.y, this.input.mousePointer.x, this.input.mousePointer.y) - 1.6);


        }
    </script>


</body>

</html>